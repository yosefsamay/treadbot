# ×”×ª×§× ×ª ×¡×¤×¨×™×•×ª
!pip install yfinance pandas --quiet

# ×™×™×‘×•× ×¡×¤×¨×™×•×ª
import yfinance as yf
import pandas as pd
import time
from IPython.display import display, HTML

# ×¨×©×™××ª 30 ×× ×™×•×ª ×××¨×™×§××™×•×ª ×¢× ×©×•×•×™ ×©×•×§ ×’×‘×•×” ×•××•×¤×¦×™×•×ª ×©×‘×•×¢×™×•×ª
tickers = [
    "AAPL", "MSFT", "GOOGL", "AMZN", "NVDA", "META", "TSLA", "BRK-B", "UNH", "LLY",
    "JPM", "JNJ", "V", "PG", "HD", "MA", "XOM", "AVGO", "CVX", "MRK",
    "PEP", "ABBV", "COST", "KO", "BAC", "MCD", "ADBE", "PFE", "CRM", "WMT"
]

results = []

for ticker in tickers:
    try:
        print(f"ğŸ” ×‘×•×“×§ ××ª {ticker}...")
        stock = yf.Ticker(ticker)

        # ×× ×•×—×” ×›×“×™ ×œ× ×œ×—×˜×•×£ Rate Limit
        time.sleep(1)

        # ×”×™×¡×˜×•×¨×™×™×ª ××—×™×¨×™× â€“ ×—×•×“×© ××—×¨×•×Ÿ
        hist = stock.history(period="1mo")
        if len(hist) < 20:
            print(f"âš ï¸ × ×ª×•× ×™× ×œ× ××¡×¤×™×§×™× ×œ-{ticker}")
            continue

        current_price = hist["Close"].iloc[-1]
        ma20 = hist["Close"].rolling(window=20).mean().iloc[-1]

        if pd.isna(ma20):
            print(f"âš ï¸ ××™×Ÿ ×××•×¦×¢ × ×¢ 20 ×œ-{ticker}")
            continue

        gap_percent = abs(current_price - ma20) / ma20

        # ××¨×•×•×— ××¢×œ 1% ×‘×œ×‘×“
        if gap_percent >= 0.01:
            results.append({
                "Ticker": ticker,
                "Current Price": round(current_price, 2),
                "MA20": round(ma20, 2),
                "Gap (%)": round(gap_percent * 100, 2)
            })

    except Exception as e:
        print(f"âŒ ×©×’×™××” ×¢× {ticker}: {e}")

# ×™×¦×™×¨×ª ×˜×‘×œ×”
df = pd.DataFrame(results).sort_values(by="Gap (%)", ascending=False).reset_index(drop=True)

# ×”×¦×’×ª ×ª×•×¦××” ×™×¤×” ×‘-Colab
if not df.empty:
    print("\nâœ… ×× ×™×•×ª ×¢× ××¨×•×•×— ××¢×œ 1% ××”×××•×¦×¢ × ×¢ 20:")
    display(HTML(df.to_html(index=False)))
else:
    print("âŒ ×œ× × ××¦××• ×× ×™×•×ª ×¢× ××¨×•×•×— ××¢×œ 1%.")
